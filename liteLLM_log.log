2024-03-16 13:09:08.053 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:09:08.053 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:09:08.053 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:09:08.063 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:09:08.063 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:09:08.063 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '127.0.0.1:8000', 'connection': 'keep-alive', 'content-length': '41', 'sec-ch-ua': '"Chromium";v="122", "Not...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd15080>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3c650>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd154e0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c610>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefd2bf10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15580>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c610>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo'], 'litellm_call_id': '52c0e3ed-b2e0-4057-8ce1-fbde02595c7d', 'litellm_...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.487 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.487 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.487 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.494 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.494 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:01.494 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bb80>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa8e10>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febef036b10>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa9bd0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo'], 'litellm_call_id': '35cc79c2-6372-456d-9a23-f14ba23881d2', 'li...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.646 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.646 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.646 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.653 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.653 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:15:10.653 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '42', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefd3cf50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15800>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefd3c750>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefc5a090>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd89c60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefd3c750>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='ehy')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='ehy')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy'], 'litellm_call_id': '8148af18-af43-4215-bb86-85fd013b00a...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.164 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.164 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.164 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.172 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.172 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:18:17.172 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0ba00>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefb85620>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefaa9b50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd156c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefaa86d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd153a0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefaaa550>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd159e0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefaa86d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo'], 'litellm_call_id': '7d276e29-d1ee-4c65-8c5d-9335b...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.911 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.911 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.911 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.918 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.918 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:19:49.918 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd485e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b560>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfe310>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefc5a510>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15e40>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febefbfc990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd156c0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefc5a510>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo'], 'litellm_call_id': 'e16a71fa-0796-45d4-94f4...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.038 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.038 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.038 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.047 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.047 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:24:19.047 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0b8e0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd8b600>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebadd0>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefb85620>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeeba5d0>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo'], 'litellm_call_id': 'aacd4528-f010-445...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.618 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.618 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.618 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.626 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.626 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:25:42.626 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd48af0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf146d1c0>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a0c0>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febef99a160>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb490>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febef99a980>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': 'e015a01b-16...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.860 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.860 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.860 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.867 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.867 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:31.867 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bfa0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febefd8b920>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebac50>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febf3a2b420>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebbe90>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15300>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb950>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15f80>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebbe90>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo']
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo'], 'litellm_call_id': '7cecc...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.260 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.260 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.260 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.267 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.267 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:26:48.267 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd480a0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '149', 'user-agent': 'Mozilla/5.0 (X11; Linux ...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febefbfd510>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febefbfd310>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15620>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebab90>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd15ee0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febefbfd310>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrh...
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjrtyhjrt...
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.011 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.011 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.011 | ERROR    | model_manager:generate_response:33 - Error during model response generation
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

  File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

> File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.018 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.018 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
2024-03-16 13:39:22.018 | ERROR    | __main__:chat:40 - Failed to process chat request
Traceback (most recent call last):

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 1131, in completion
    response = anthropic.completion(
               │         └ <function completion at 0x7febef912700>
               └ <module 'litellm.llms.anthropic' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py'>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/llms/anthropic.py", line 135, in completion
    if message["role"] == "system":
       └ 'yo'

TypeError: string indices must be integers, not 'str'


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "/home/teilo/Code/lugia/lugia/main.py", line 45, in <module>
    uvicorn.run(app, host="0.0.0.0", port=8000)
    │       │   └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
    │       └ <function run at 0x7febefb85440>
    └ <module 'uvicorn' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/main.py", line 575, in run
    server.run()
    │      └ <function Server.run at 0x7febefb85940>
    └ <uvicorn.server.Server object at 0x7febef0a2610>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/server.py", line 62, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x7febefb859e0>
           │       │   └ <uvicorn.server.Server object at 0x7febef0a2610>
           │       └ <function run at 0x7febf38aaf20>
           └ <module 'asyncio' from '/usr/lib/python3.11/asyncio/__init__.py'>
  File "/usr/lib/python3.11/asyncio/runners.py", line 190, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x7febefd21030>
           │      └ <function Runner.run at 0x7febf3137f60>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at /home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x7febf3135bc0>
           │    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x7febef036210>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 641, in run_until_complete
    self.run_forever()
    │    └ <function BaseEventLoop.run_forever at 0x7febf3135b20>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 608, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x7febf3137920>
    └ <_UnixSelectorEventLoop running=True closed=False debug=False>
  File "/usr/lib/python3.11/asyncio/base_events.py", line 1936, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x7febf38a47c0>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/usr/lib/python3.11/asyncio/events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <TaskStepMethWrapper object at 0x7febefd0bcd0>()>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7febefc5a210>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
          └ <fastapi.applications.FastAPI object at 0x7febefc09c90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x7febf01f6dd0>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 91, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
          │    │               │      │        │                     └ Headers({'host': '0.0.0.0:8000', 'connection': 'keep-alive', 'content-length': '41', 'user-agent': 'Mozilla/5.0 (X11; Linux x...
          │    │               │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x7febf3a2b420>
          │    │               │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │               └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function CORSMiddleware.simple_response at 0x7febefc0e0c0>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/cors.py", line 146, in simple_response
    await self.app(scope, receive, send)
          │    │   │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
          │                            │    │    │     │      │        └ functools.partial(<bound method CORSMiddleware.send of <starlette.middleware.cors.CORSMiddleware object at 0x7febef066590>>, ...
          │                            │    │    │     │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │    │     └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    │    └ <starlette.requests.Request object at 0x7febeeebbdd0>
          │                            │    └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
          │                            └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x7febefc5b390>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <bound method Router.app of <fastapi.routing.APIRouter object at 0x7febef0a2e90>>
          └ <fastapi.routing.APIRouter object at 0x7febef0a2e90>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x7febf2179120>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 299, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x7febefc0f600>
          └ APIRoute(path='/chat/', name='chat', methods=['POST'])
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
          │                            │    │        │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd89c60>
          │                            │    │        │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │                            │    │        └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │                            │    └ <starlette.requests.Request object at 0x7febeeebb690>
          │                            └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
          └ <function wrap_app_handling_exceptions at 0x7febf2147a60>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
          │   │      │        └ <function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0x7febefd15c60>
          │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.h11_impl.RequestResponseCycle object at 0x7febeeebb990>>
          │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.4'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          └ <function request_response.<locals>.app.<locals>.app at 0x7febefd8b880>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/starlette/routing.py", line 74, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x7febeeebb690>
                     └ <function get_request_handler.<locals>.app at 0x7febefc0f560>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 278, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x7febf2178c20>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'request': ChatRequest(model='claude-3-haiku', content='yo')}
                 │         └ <function chat at 0x7febefc0ef20>
                 └ <fastapi.dependencies.models.Dependant object at 0x7febefbfd1d0>

> File "/home/teilo/Code/lugia/lugia/main.py", line 36, in chat
    response = await model_manager.generate_response(request.model, user_messages)
                     │             │                 │       │      └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │             │                 │       └ 'claude-3-haiku'
                     │             │                 └ ChatRequest(model='claude-3-haiku', content='yo')
                     │             └ <function ModelManager.generate_response at 0x7febefc0d440>
                     └ <model_manager.ModelManager object at 0x7febefc0b410>

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 34, in generate_response
    raise e

  File "/home/teilo/Code/lugia/lugia/model_manager.py", line 29, in generate_response
    response = await litellm.completion(model=model_name, messages=messages)
                     │       │                │                    └ ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl;jrt;hkljmrt;hrthl;rtkhl´trrtl´hkrtlhkHtyrhyrthjr...
                     │       │                └ 'claude-3-haiku-20240307'
                     │       └ <function completion at 0x7febef8885e0>
                     └ <module 'litellm' from '/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/__init__.py'>

  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2727, in wrapper
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 2628, in wrapper
    result = original_function(*args, **kwargs)
             │                  │       └ {'model': 'claude-3-haiku-20240307', 'messages': ['yo', 'yo', 'ehy', 'yo', 'yo', 'yo', 'yo', 'yo', 'wetwerktḱwertĺekrgĺkertgl...
             │                  └ ()
             └ <function completion at 0x7febef888360>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/main.py", line 2055, in completion
    raise exception_type(
          └ <function exception_type at 0x7febf01cd080>
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8180, in exception_type
    raise e
  File "/home/teilo/Code/lugia/.venv/lib/python3.11/site-packages/litellm/utils.py", line 8155, in exception_type
    raise APIConnectionError(
          └ <class 'litellm.exceptions.APIConnectionError'>

litellm.exceptions.APIConnectionError: string indices must be integers, not 'str'
